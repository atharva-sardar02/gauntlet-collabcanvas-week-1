# AI Agent Architecture Diagram

## High-Level Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER'S BROWSER                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Firebase Hosting (Free Tier)                       â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚         CollabCanvas React App                           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Canvas UI (Konva)                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Command Bar (Ctrl+/)                                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ AI Agent Context                                      â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚      â”‚                                                          â”‚ â”‚
â”‚  â”‚      â”‚ 1. User types: "Create a login form"                    â”‚ â”‚
â”‚  â”‚      â”‚ 2. Get Firebase ID token                                â”‚ â”‚
â”‚  â”‚      â–¼                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚         Firebase Authentication                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Issues ID tokens (JWT)                                â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Token includes: uid, email, exp                       â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ 3. POST /ai/command
                         â”‚    Authorization: Bearer <Firebase-ID-Token>
                         â”‚    Body: { command, canvasState, requestId }
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AWS CLOUD                                  â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          API Gateway (HTTP API)                                â”‚ â”‚
â”‚  â”‚  â€¢ Endpoint: https://abc123.execute-api.us-east-1.amazonaws... â”‚ â”‚
â”‚  â”‚  â€¢ CORS: Allow Firebase Hosting origin                        â”‚ â”‚
â”‚  â”‚  â€¢ Throttling: 20 req/min per IP                              â”‚ â”‚
â”‚  â”‚  â€¢ Rate limiting: Burst = 10 requests                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚      â”‚                                                               â”‚
â”‚      â”‚ 4. Forwards request to Lambda                                â”‚
â”‚      â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          AWS Lambda Function                                   â”‚ â”‚
â”‚  â”‚          Name: collabcanvas-ai-agent                           â”‚ â”‚
â”‚  â”‚          Runtime: Node.js 20.x                                 â”‚ â”‚
â”‚  â”‚          Memory: 512 MB                                        â”‚ â”‚
â”‚  â”‚          Timeout: 30 seconds                                   â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Handler: src/index.ts                                    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Step 1: Verify Firebase token                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€â–º firebase-admin.auth().verifyIdToken()             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â””â”€â–º Extract uid, email                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Step 2: Check rate limit                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â””â”€â–º In-memory counter: 20 req/min per user            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Step 3: Check idempotency cache                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â””â”€â–º Return cached result if requestId exists          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Step 4: Get OpenAI API key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                     â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Step 5: Call LangChain AI Agent                  â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€â–º Build canvas context                       â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€â–º Define 10 tool schemas                     â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€â–º Create ChatOpenAI model â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€â–º Invoke with system prompt           â”‚      â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â””â”€â–º Parse tool calls from response      â”‚      â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                              â”‚      â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Step 6: Cache result (5 min TTL)          â”‚      â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                              â”‚      â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Step 7: Return tool calls                  â”‚      â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    Example: [                                â”‚      â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚      { name: 'createText', args: {...} },   â”‚      â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚      { name: 'createShape', args: {...} },  â”‚      â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚      { name: 'align', args: {...} }         â”‚      â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    ]                                         â”‚      â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚      â”‚ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚                                        â”‚                           â”‚ â”‚
â”‚                                        â”‚                           â”‚ â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                   â”‚ â”‚
â”‚         â”‚                                      â”‚                   â”‚ â”‚
â”‚         â–¼                                      â–¼                   â”‚ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  Secrets Manager   â”‚            â”‚       CloudWatch Logs      â”‚ â”‚ â”‚
â”‚  â”‚                    â”‚            â”‚                            â”‚ â”‚ â”‚
â”‚  â”‚  Secret:           â”‚            â”‚  Log Group:                â”‚ â”‚ â”‚
â”‚  â”‚  collabcanvas-     â”‚            â”‚  /aws/lambda/              â”‚ â”‚ â”‚
â”‚  â”‚  openai-key        â”‚            â”‚  collabcanvas-ai-agent     â”‚ â”‚ â”‚
â”‚  â”‚                    â”‚            â”‚                            â”‚ â”‚ â”‚
â”‚  â”‚  {                 â”‚            â”‚  Logs:                     â”‚ â”‚ â”‚
â”‚  â”‚   OPENAI_API_KEY:  â”‚            â”‚  â€¢ User ID                 â”‚ â”‚ â”‚
â”‚  â”‚   "sk-..."         â”‚            â”‚  â€¢ Command text            â”‚ â”‚ â”‚
â”‚  â”‚  }                 â”‚            â”‚  â€¢ Tool calls count        â”‚ â”‚ â”‚
â”‚  â”‚                    â”‚            â”‚  â€¢ Latency                 â”‚ â”‚ â”‚
â”‚  â”‚  Cost: $0.40/mo    â”‚            â”‚  â€¢ Errors                  â”‚ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                                                                     â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ 5. Response: { toolCalls: [...], latency: 1234 }
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USER'S BROWSER (AGAIN)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         CollabCanvas React App                                 â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  6. Execute tool calls locally:                                 â”‚ â”‚
â”‚  â”‚     â€¢ createText('Username', 100, 100)                          â”‚ â”‚
â”‚  â”‚       â””â”€â–º canvasContext.addShape({ type: 'text', ... })        â”‚ â”‚
â”‚  â”‚     â€¢ createShape('rectangle', 100, 150, 200, 40)               â”‚ â”‚
â”‚  â”‚       â””â”€â–º canvasContext.addShape({ type: 'rectangle', ... })   â”‚ â”‚
â”‚  â”‚     â€¢ createText('Password', 100, 220)                          â”‚ â”‚
â”‚  â”‚       â””â”€â–º canvasContext.addShape({ type: 'text', ... })        â”‚ â”‚
â”‚  â”‚     â€¢ createShape('rectangle', 100, 270, 200, 40)               â”‚ â”‚
â”‚  â”‚       â””â”€â–º canvasContext.addShape({ type: 'rectangle', ... })   â”‚ â”‚
â”‚  â”‚     â€¢ createShape('rectangle', 150, 340, 100, 40)               â”‚ â”‚
â”‚  â”‚       â””â”€â–º canvasContext.addShape({ type: 'rectangle', ... })   â”‚ â”‚
â”‚  â”‚     â€¢ createText('Login', 170, 350)                             â”‚ â”‚
â”‚  â”‚       â””â”€â–º canvasContext.addShape({ type: 'text', ... })        â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  7. Shapes created â†’ sync to Firestore                          â”‚ â”‚
â”‚  â”‚     â””â”€â–º Other users see changes in real-time                    â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  8. Show toast: "Created login form (6 elements)"               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ All changes synced via Firestore
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Firebase Firestore (Free Tier)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  canvases/{canvasId}/shapes/{shapeId}                          â”‚ â”‚
â”‚  â”‚  â€¢ Real-time sync to all connected users                       â”‚ â”‚
â”‚  â”‚  â€¢ Presence tracking                                            â”‚ â”‚
â”‚  â”‚  â€¢ Conflict resolution (last-write-wins)                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Sequence

```
User                 Frontend              API Gateway      Lambda              OpenAI         Firestore
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚ 1. Ctrl+/           â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚ 2. Type command     â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚ 3. Get Firebase     â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚    ID token         â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚ 4. POST /ai/command â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚    with token        â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚ 5. Forward   â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚ 6. Verify token   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚ 7. Get API key    â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚    from Secrets   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚ 8. Call OpenAI    â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚    with tools     â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚ 9. Tool calls     â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚ 10. Response â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚ 11. Tool calls JSON â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚ 12. Execute tools    â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚     (create shapes)  â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚ 13. Add shapes to    â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚     Firestore        â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚ 14. See shapes      â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚     on canvas       â”‚                      â”‚              â”‚                   â”‚               â”‚
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚              â”‚                   â”‚               â”‚
 â”‚                      â”‚                      â”‚              â”‚                   â”‚               â”‚
```

---

## Tool Execution Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenAI Response Example                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  {                                                                â”‚
â”‚    "toolCalls": [                                                 â”‚
â”‚      {                                                            â”‚
â”‚        "type": "function",                                        â”‚
â”‚        "function": {                                              â”‚
â”‚          "name": "createText",                                    â”‚
â”‚          "arguments": {                                           â”‚
â”‚            "text": "Username",                                    â”‚
â”‚            "x": 100,                                              â”‚
â”‚            "y": 100,                                              â”‚
â”‚            "fontSize": 14                                         â”‚
â”‚          }                                                        â”‚
â”‚        }                                                          â”‚
â”‚      },                                                           â”‚
â”‚      {                                                            â”‚
â”‚        "type": "function",                                        â”‚
â”‚        "function": {                                              â”‚
â”‚          "name": "createShape",                                   â”‚
â”‚          "arguments": {                                           â”‚
â”‚            "type": "rectangle",                                   â”‚
â”‚            "x": 100,                                              â”‚
â”‚            "y": 120,                                              â”‚
â”‚            "width": 200,                                          â”‚
â”‚            "height": 40,                                          â”‚
â”‚            "fill": "#FFFFFF",                                     â”‚
â”‚            "stroke": "#000000"                                    â”‚
â”‚          }                                                        â”‚
â”‚        }                                                          â”‚
â”‚      },                                                           â”‚
â”‚      ...more tool calls...                                        â”‚
â”‚    ],                                                             â”‚
â”‚    "latency": 1234                                                â”‚
â”‚  }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Frontend receives response
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  executeToolCalls() Function                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  for (const toolCall of toolCalls) {                             â”‚
â”‚    switch (toolCall.function.name) {                             â”‚
â”‚                                                                   â”‚
â”‚      case 'createShape':                                         â”‚
â”‚        canvasContext.addShape({                                  â”‚
â”‚          type: args.type,         // 'rectangle'                 â”‚
â”‚          x: args.x,               // 100                         â”‚
â”‚          y: args.y,               // 120                         â”‚
â”‚          width: args.width,       // 200                         â”‚
â”‚          height: args.height,     // 40                          â”‚
â”‚          fill: args.fill,         // '#FFFFFF'                   â”‚
â”‚        });                                                        â”‚
â”‚        break;                                                     â”‚
â”‚                                                                   â”‚
â”‚      case 'createText':                                          â”‚
â”‚        canvasContext.addShape({                                  â”‚
â”‚          type: 'text',                                           â”‚
â”‚          text: args.text,         // 'Username'                  â”‚
â”‚          x: args.x,               // 100                         â”‚
â”‚          y: args.y,               // 100                         â”‚
â”‚          fontSize: args.fontSize, // 14                          â”‚
â”‚        });                                                        â”‚
â”‚        break;                                                     â”‚
â”‚                                                                   â”‚
â”‚      case 'align':                                               â”‚
â”‚        canvasContext.alignShapes(args.ids, args.mode);           â”‚
â”‚        break;                                                     â”‚
â”‚                                                                   â”‚
â”‚      // ... handle other tools ...                               â”‚
â”‚    }                                                              â”‚
â”‚  }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Each tool call triggers Firestore update
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Firestore Update                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  canvases/{canvasId}/shapes/{shapeId1}  â† createText            â”‚
â”‚  canvases/{canvasId}/shapes/{shapeId2}  â† createShape           â”‚
â”‚  canvases/{canvasId}/shapes/{shapeId3}  â† createText            â”‚
â”‚  canvases/{canvasId}/shapes/{shapeId4}  â† createShape           â”‚
â”‚  ...                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Real-time sync
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  All Connected Users See Changes Immediately                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Authentication (Firebase)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ User logs in via Firebase Auth                               â”‚
â”‚  â€¢ Firebase issues JWT ID token                                 â”‚
â”‚  â€¢ Token contains: uid, email, expiration                       â”‚
â”‚  â€¢ Token expires after 1 hour (auto-refresh)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Authorization Header                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6...          â”‚
â”‚                                                                   â”‚
â”‚  â€¢ Sent with every AI command request                           â”‚
â”‚  â€¢ Verified by Lambda before processing                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Token Verification (Lambda)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  const decodedToken = await admin.auth().verifyIdToken(token);  â”‚
â”‚                                                                   â”‚
â”‚  Checks:                                                         â”‚
â”‚  âœ“ Token signature (Firebase public key)                        â”‚
â”‚  âœ“ Token not expired                                             â”‚
â”‚  âœ“ Token issued by correct Firebase project                     â”‚
â”‚  âœ“ Token audience matches                                        â”‚
â”‚                                                                   â”‚
â”‚  If invalid â†’ 401 Unauthorized                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Rate Limiting (Per User)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Track requests by user ID (uid)                              â”‚
â”‚  â€¢ Limit: 20 requests per minute                                â”‚
â”‚  â€¢ Sliding window: resets after 60 seconds                      â”‚
â”‚  â€¢ If exceeded â†’ 429 Too Many Requests                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. API Key Security (Secrets Manager)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ OpenAI API key stored in AWS Secrets Manager                 â”‚
â”‚  â€¢ NOT in code, NOT in environment variables                    â”‚
â”‚  â€¢ Lambda IAM role grants read access                           â”‚
â”‚  â€¢ Retrieved at runtime: getSecret(SECRET_NAME)                 â”‚
â”‚  â€¢ Never exposed to frontend                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. CORS Protection (API Gateway)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Access-Control-Allow-Origin: https://collabcanvas-f7ee2.web... â”‚
â”‚  Access-Control-Allow-Headers: Authorization, Content-Type       â”‚
â”‚  Access-Control-Allow-Methods: POST, OPTIONS                     â”‚
â”‚                                                                   â”‚
â”‚  â€¢ Only Firebase Hosting origin allowed                         â”‚
â”‚  â€¢ Prevents unauthorized websites from calling API              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Cost Breakdown

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AWS Costs (Monthly)                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Lambda                                                          â”‚
â”‚  â”œâ”€ Free Tier: 1M requests/month                                â”‚
â”‚  â”œâ”€ Estimate: 30,000 requests/month (1,000/day)                 â”‚
â”‚  â”œâ”€ After free tier: $0.20 per 1M requests                      â”‚
â”‚  â””â”€ Cost: $0.01/month                                            â”‚
â”‚                                                                  â”‚
â”‚  API Gateway (HTTP API)                                          â”‚
â”‚  â”œâ”€ Free Tier: 1M requests/month (first 12 months)              â”‚
â”‚  â”œâ”€ After free tier: $1.00 per 1M requests                      â”‚
â”‚  â””â”€ Cost: $0.03/month                                            â”‚
â”‚                                                                  â”‚
â”‚  Secrets Manager                                                 â”‚
â”‚  â”œâ”€ $0.40/month per secret                                       â”‚
â”‚  â”œâ”€ 1 secret (OPENAI_API_KEY)                                    â”‚
â”‚  â””â”€ Cost: $0.40/month                                            â”‚
â”‚                                                                  â”‚
â”‚  CloudWatch Logs                                                 â”‚
â”‚  â”œâ”€ Free Tier: 5 GB ingestion/month                             â”‚
â”‚  â”œâ”€ Estimate: < 1 GB/month                                       â”‚
â”‚  â””â”€ Cost: $0.00/month                                            â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Total AWS: ~$0.50/month (after free tier)                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  OpenAI Costs (Variable)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  GPT-4 Turbo                                                     â”‚
â”‚  â”œâ”€ Input: $0.01 per 1K tokens                                  â”‚
â”‚  â”œâ”€ Output: $0.03 per 1K tokens                                 â”‚
â”‚  â”œâ”€ Avg command: 500 input + 200 output tokens                  â”‚
â”‚  â”œâ”€ Cost per command: $0.01                                      â”‚
â”‚  â””â”€ 100 commands/day = $1.00/day = $30/month                    â”‚
â”‚                                                                  â”‚
â”‚  GPT-3.5 Turbo (Recommended for cost)                            â”‚
â”‚  â”œâ”€ Input: $0.0005 per 1K tokens                                â”‚
â”‚  â”œâ”€ Output: $0.0015 per 1K tokens                               â”‚
â”‚  â”œâ”€ Avg command: 500 input + 200 output tokens                  â”‚
â”‚  â”œâ”€ Cost per command: $0.0005                                    â”‚
â”‚  â””â”€ 100 commands/day = $0.05/day = $1.50/month                  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Total with GPT-3.5: ~$2.00/month                          â”‚  â”‚
â”‚  â”‚  Total with GPT-4: ~$30.50/month                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Comparison: Firebase Functions vs AWS Lambda

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feature                 â”‚ Firebase Functions â”‚ AWS Lambda         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Free Tier               â”‚ 125K invocations   â”‚ 1M requests        â”‚
â”‚                         â”‚ 40 GB-sec compute  â”‚ 400K GB-sec        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Requires Paid Plan      â”‚ YES (Blaze)        â”‚ NO                 â”‚
â”‚ for External APIs       â”‚ ($0.40/GB)         â”‚                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Cost at 30K req/month   â”‚ ~$5-10/month       â”‚ ~$0.50/month       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Setup Complexity        â”‚ Easy               â”‚ Medium             â”‚
â”‚                         â”‚ (firebase deploy)  â”‚ (AWS Console)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Monitoring              â”‚ Firebase Console   â”‚ CloudWatch         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Secrets Management      â”‚ firebase functions â”‚ Secrets Manager    â”‚
â”‚                         â”‚ :secrets:set       â”‚ ($0.40/month)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Cold Start              â”‚ ~1-2s              â”‚ ~1-2s              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Recommendation          â”‚ Good for           â”‚ âœ“ Best for         â”‚
â”‚                         â”‚ Firebase-only apps â”‚ external APIs      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Why This Architecture?

### âœ… Advantages
1. **Avoid Firebase Blaze Plan**: Stay on free tier for Firebase
2. **Cost-Effective**: ~$2/month total (AWS + OpenAI GPT-3.5)
3. **Secure**: API keys in AWS Secrets Manager, never exposed
4. **Scalable**: Auto-scales with AWS Lambda
5. **Isolated**: Backend separate from frontend, easier to maintain
6. **Flexible**: Easy to swap AI providers (OpenAI â†’ Anthropic â†’ etc.)
7. **Monitoring**: CloudWatch provides detailed logs and metrics

### âš ï¸ Trade-offs
1. **Setup Complexity**: Requires AWS account and configuration
2. **Two Cloud Providers**: Firebase + AWS (instead of just Firebase)
3. **Cold Starts**: ~1-2s initial latency (can be mitigated with provisioned concurrency)

### ğŸ¯ Best For
- Projects with external API calls (OpenAI, Anthropic, etc.)
- Cost-conscious deployments
- Need for flexible backend logic
- Long-term scalability


